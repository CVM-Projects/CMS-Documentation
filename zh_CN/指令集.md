# 指令集

## 说明

在结果位、参数位，使用的标志：
- R 寄存器
    - Rd 数据寄存器 = Rd.d + Rd.s
        - Rd.d 动态数据寄存器
        - Rd.s 静态数据寄存器
    - Re 环境寄存器
    - Rf 函数寄存器
- I 标识符
    - If 函数标识符
- D 数据常量 = D.s + D.l
    - Dp 指针
    - Dt 类型 = Dt.s
    - Dn 整型数据
    - D_.l 数据表中数据
    - D_.s 指令中数据
- P 指针 = Dp + Rd(Dp)
- \- 无

若要求寄存器中存储某种类型的数据，那么使用 R(D) 的形式。如：R(Dp) 表示要求传入带有指针数据的寄存器。当不符合要求时，会抛出错误。（错误是否会处理与环境的行为有关。）

## 数据寄存器取值方式

- 直接使用寄存器： %1 。
- 取 %env 环境下的寄存器： %1(%env) 。
- 取寄存器所指向的数据的地址：(%1) 。静态数据寄存器通常是寄存器本身的地址，动态数据寄存器通常在引用之前需要分配一个空间。
- 取寄存器所保存的地址+x： %1[x]；其中 %1[0] = %1 。这要求寄存器存储的数据必须是Dp。

## 指令分歧

一条 CMS 指令会对应一种操作，一个名称下会有多条指令处理不同情况。

## 空指令

指令|说明
---|---
nop|空指令，不执行任何操作

## 寄存器传输指令

指令|结果位|第一参数|辅助参数|说明
---|----|------|-------|-------|-----
mov|Rd|Rd||将某一数据寄存器保存的数据传送给另一数据寄存器

### 示例

```
mov %1, %2
mov %1(%env), %2
```

### 备注

mov 指令要求，传输数据时，两个数据寄存器所持有的空间大小相同。否则，会抛出错误。

## 数据加载指令

指令|结果位|第一参数|辅助参数|说明
---|------|-------|-------|-----
load|Rd|D|T|以类型为T的模式，将数据加载到数据寄存器中

### 示例

```
load %1, 5, cms#int32  ; 从指令中加载数据

.data #1, 0x00000005

load %2, #1, cms#int32 ; 从带有值含义的数据段中加载数据

.array #2, 0x05 0x00 0x00 0x00
load %3, #2, cms#int32 ; 从给定序的数据段中加载数据
```

### 备注

数据的加载方式详见 [](./数据.md)

## 动态数据寄存器操作指令

指令|结果位|第一参数|辅助参数|说明
---|------|-------|-------|-----
tset|Rd.d|Dt||设置动态数据寄存器保存的类型

### 示例

```
tset  %1, cms#int32
```

## 数据操作指令

指令|模式|结果位|第一参数|第二参数|说明
---|---|-----|-------|-------|----
cpyn||P1|P2|Dn/Rd(Dn)|将 Dp2 开始的 Dn 个字节复制到 Dp1 对应的位置

## 函数调用指令

函数调用指令与被调用函数的运行模式息息相关，也与当前函数的运行模式有关。

指令|模式|结果位|第一参数|其他参数|多参？|说明
---|-|------|-------|--------|-----|-----
farg||-|D/I/R||√|将参数打包
fcal||R|R/If|||调用函数，使用打包的参数
ffce||-|R|||检查是否为函数
face||-|R/If|||检查对于已打包的参数，函数调用是否合法
ret||-||||从当前函数中返回
call||R|R/If|D/I/R|√|伪指令，在汇编期间转化为farg与fcal

当变量存储了函数时，需要经过如下操作：

```
; (let f +)
let  f, +  ; 将 + 通过 let 操作赋给 变量 f

; (f 5 6)
mvdv %1, f  ; 将动态变量 f 存储的函数对象移至寄存器%1中。
ffce %1     ; 检查 %1 寄存器是否为函数对象。若不是则抛出错误。
farg 5 6    ; 将 5 和 6 作为参数打包。
face %1     ; 检查参数对 %1 的调用是否合法。若不是则抛出错误。
fcal %2, %1 ; 调用函数 %1，即 f，也即 + ；并将结果传给 %2 寄存器。
```

当然，通过一定的预先检验（通常为在编译期的静态检查），可以省略部分运行时检查代码。优化后的代码如下：

```
; (f 5 6)
mvdv %1, f
farg 5 6
fcal %2, %1
```

## 环境操作指令

指令|参数|说明
---|-------|---
esup||获取当前环境的父环境到临时环境寄存器中。
esub|R/D|获取当前环境 编号为 [R/D] 的位置的子环境到临时环境寄存器中，编号从 0 起始。
ecpy||获取当前环境的拷贝到临时环境寄存器中。
jenv||跳转到临时环境寄存器所引用的环境中。跳转的同时会自动将目标环境作为当前环境的子环境。
jesp||跳转到父环境中。


指令|参数|全称|说明
---|-------|-|---
fbec|R/If|Func Bind Env Curr|将指定函数与当前环境绑定。返回一个函数到函数临时寄存器中。
fbet|R/If|Func Bind Env Temp|将指定函数与临时环境寄存器中引用的环境绑定。返回一个函数到函数临时寄存器中。
