# 寄存器

## 种类

CMS 是基于寄存器的，且寄存器数目在理论上是无限多的。

CMS 寄存器有如下几种：

- 通用寄存器： %t + 数字，数字为 从 1 开始的整数。每个线程间是相互独立的。
- 全局寄存器： %g + 数字，数字为 从 1 开始的整数。跨线程的共有寄存器。
- 私有寄存器： % + 数字，数字为 从 1 开始的整数。函数等进程私有的寄存器。
- 结果寄存器： %res ， 存储函数调用的结果的寄存器，实际上是调用函数指令中所指明的目标寄存器。

示例：

```
mov %1, %2
```

就是将 2 号 寄存器里的数据送入 1 号 寄存器中。

有时，不希望储存结果时，通过使用 %0 来表示舍弃运算的结果。

出于多线程的考虑，每个线程下都有名称相同的通用寄存器组，在不同线程下，调用不同的通用寄存器组。因此不会由通用寄存器冲突引发线程问题。

除了上述寄存器，还有一些临时寄存器。

这些临时寄存器包括：

- 环境临时寄存器
- 函数临时寄存器

临时寄存器保存的内容在 call 指令前后是无法保证有效的。
每个线程内均有一组临时寄存器。

## 数据寄存器

每个环境都有一组数据寄存器。

数据寄存器分为静态数据寄存器和动态数据寄存器。

为了方便处理，动态数据寄存器的编号排在静态数据寄存器之前。

### 处理方式

数据寄存器通常存储函数调用的结果，或者代码中硬性赋入的初值。

一个动态数据寄存器在存储数据时，包含类型信息和数据的地址。

如
```
(let a 5i32)

; a 的结构表示（理论意义，不同实现有所不同）：
{
  type : Int32,
  data : int32_t* -> 5
}
```

而静态数据寄存器的存储则为：

```
data : 5              ;; 直接拥有指定空间
; or
data : int32_t* -> 5  ;; 存储所拥有的空间的地址
```

数据寄存器可能会在栈(Stack)上拥有特定的地址，但这是具体的实现所规定的， CMS 对此没有特殊要求。

为避免出现寄存器引用的混乱，编译器应该具有 **自动区分引用了动态变量数据的寄存器和引用（或存储）了静态变量数据的寄存器** 的能力。
