# 环境

环境 (Environment) 是 CMS 的核心之一。

按 运行模式 (Runtime Mode) 区分，环境可分为 静态环境 (Static Environment)、动态环境 (Dynamic Environment)、混合环境 (Multiply Environment)。

按 处理范围 (Scope) 区分，环境可分为 全局环境 (Global Environment)、局部环境 (Local Environment)。

## 组成

一个环境包含了以下几个内容：

- 环境信息 (Infomation)
    - 子环境 (Sub Environment)
    - 父环境 (Super Environment)
- 寄存器组 (Register Set)
- 数据 (Data)
- 程序 (Program)

## 寄存器组

寄存器组 (Register Set) 是一组寄存器的通称。寄存器组是组成环境的重要一员。

按照运行模式来分，寄存器组有 静态 和 动态 两种。

按照寄存器组的长度，寄存器组有 固定长度 和 可变长度 两种。

局部环境的寄存器组是根据该环境的模式改变的。环境为静态时，只有静态寄存器组；环境为动态时，只有动态寄存器组；环境为混合态时，静态与动态寄存器组均存在。

## 环境的创建与销毁

所有环境销毁前，均需先销毁其子环境。

### 程序开始

程序开始，会创建一个全局环境。
全局环境的数据与全局声明有关。
全局环境会创建一个局部环境，这个局部环境就是程序运行的起点。

程序结束前，会销毁全局环境。
在销毁全局环境前，会将所有的局部环境销毁。

### 创建线程

全局环境在最初时，会创建一个主线程的局部环境。
当创建新线程时，会创建新的局部环境。

线程结束后，会销毁该线程局部环境。

### 调用函数

当调用一个 CMS 的函数时，就会创建一个局部环境。
这个环境的模式与函数的模式和调用的模式有关。
函数声明中，会指定寄存器的数目和类型。这就是环境中寄存器组创建的依据。

调用函数结束后，会销毁该函数局部环境。

### 复制环境

使用指令可以复制当前的环境。这时会创建一个当前环境的副本。

## 数据

所有在环境内引用的数据，都被该环境所管理。在销毁该环境时，一并销毁数据。

当跨环境引用了数据时，数据归属于级别更高的环境（如该环境的父环境）。

## 程序

程序表示该环境内所引用的执行代码和执行状态。

当进入新的环境时，原环境的状态被保留；回到原环境时，可以恢复状态。

## 引用

环境是可以作为数据传递的。

一些闭包函数中要求传递环境作为参数，此时可以将环境传递。
